# r3LAY Docker Compose Configuration
#
# Profiles:
#   default   - r3LAY with SearXNG for web search
#   standalone - r3LAY only (no web search)
#   nvidia    - r3LAY with NVIDIA GPU support + SearXNG
#
# Usage:
#   docker compose --profile default up -d
#   docker compose run r3lay
#
#   docker compose --profile nvidia up -d
#   docker compose run r3lay-nvidia
#
# Environment variables:
#   PROJECT_PATH - Host directory to mount as /project (default: current dir)
#   HF_CACHE_PATH - HuggingFace cache directory (default: ~/.cache/huggingface)
#   GGUF_PATH - GGUF models directory (default: ~/.r3lay/models)
#   SEARXNG_SECRET - SearXNG secret key

services:
  # ===========================================================================
  # r3LAY (CPU/Ollama) with SearXNG
  # ===========================================================================
  r3lay:
    build: .
    volumes:
      - ${PROJECT_PATH:-.}:/project
      - ${HF_CACHE_PATH:-~/.cache/huggingface}:/root/.cache/huggingface:ro
    environment:
      - R3LAY_OLLAMA_ENDPOINT=http://host.docker.internal:11434
      - R3LAY_HF_CACHE_PATH=/root/.cache/huggingface
      - R3LAY_SEARXNG_ENDPOINT=http://searxng:8080
    extra_hosts:
      # Docker Desktop (macOS/Windows) - for accessing host Ollama
      - "host.docker.internal:host-gateway"
    stdin_open: true
    tty: true
    depends_on:
      searxng:
        condition: service_healthy
    profiles:
      - default

  # ===========================================================================
  # r3LAY Standalone (no SearXNG)
  # ===========================================================================
  r3lay-standalone:
    build: .
    volumes:
      - ${PROJECT_PATH:-.}:/project
      - ${HF_CACHE_PATH:-~/.cache/huggingface}:/root/.cache/huggingface:ro
    environment:
      - R3LAY_OLLAMA_ENDPOINT=http://host.docker.internal:11434
      - R3LAY_HF_CACHE_PATH=/root/.cache/huggingface
    extra_hosts:
      - "host.docker.internal:host-gateway"
    stdin_open: true
    tty: true
    profiles:
      - standalone

  # ===========================================================================
  # r3LAY with NVIDIA GPU Support
  # ===========================================================================
  r3lay-nvidia:
    build:
      context: .
      dockerfile: Dockerfile.nvidia
    volumes:
      - ${PROJECT_PATH:-.}:/project
      - ${HF_CACHE_PATH:-~/.cache/huggingface}:/root/.cache/huggingface:ro
      - ${GGUF_PATH:-~/.r3lay/models}:/root/.r3lay/models:ro
    environment:
      - R3LAY_OLLAMA_ENDPOINT=http://host.docker.internal:11434
      - R3LAY_HF_CACHE_PATH=/root/.cache/huggingface
      - R3LAY_GGUF_FOLDER=/root/.r3lay/models
      - R3LAY_SEARXNG_ENDPOINT=http://searxng:8080
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    stdin_open: true
    tty: true
    depends_on:
      searxng:
        condition: service_healthy
    profiles:
      - nvidia

  # ===========================================================================
  # SearXNG Meta Search Engine
  # ===========================================================================
  searxng:
    image: searxng/searxng:latest
    ports:
      - "8080:8080"
    environment:
      - SEARXNG_SECRET=${SEARXNG_SECRET:-r3lay-secret-key}
    volumes:
      - searxng-data:/etc/searxng
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    profiles:
      - default
      - search
      - nvidia

volumes:
  searxng-data:
